
{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="book-detail-container">
    <!-- Left Content Column -->
    <div class="left-content">
        <!-- Main Book Information Section -->
        <div class="book-main-section">
            <!-- Book Picture - Top Left Corner-->
            <div class="book-image-container">
                {% if book.image %}
                    <img src="{{ book.image.url }}" alt="Book.title" class="book-cover">
                {% else %}
                    <div class="book-placeholder">
                        <i class="fas fa-book"></i>
                        <p>No Image </p>
                    </div>
                {% endif %}
            </div>




            <!-- Book Blurb Section -->
            <div class="book-blurb-container">
                <div class="book-blurb-frame">
                    <h4>About This Book</h4>
                    {% if book.blurb %}
                        <div class="book-blurb-text">
                            {{ book.blurb|linebreaks }}
                        </div>
                    {% else %}
                        <p class="text-muted">No book description available</p>
                    {% endif %}
                </div>
            </div>

            <!-- Book Details - Right of Picture -->
            <div class="book-details-container">
                <h1 class="book-title">{{ book.title }}</h1>
                <h3 class="book-author">{{ book.author }}</h3>

                {% if book.publisher %}
                <div class="book-publisher">
                    <strong>Publisher:</strong> {{ book.publisher }}
                </div>
                {% endif %}

                <div class="book-genre">
                    <strong>Genre:</strong>
                    {% if book.genre.all %}
                        {% for genre in book.genre.all %}
                            <span class="badge bg-secondary"> {{ genre.genre_name }}</span>
                            {% if not forloop.last %}, {% endif%}
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">None</span>
                    {% endif %}
                </div>


                {% if book.published_date %}
                <div class="book-info">
                    <strong>Published:</strong> {{ book.published_date|date:"M d, Y" }}
                </div>
                {% endif %}

                {% if book.ean %}
                <div class="book-info">
                    <strong>EAN:</strong> {{ book.ean }}
                </div>
                {% endif %}

                {% if book.isbn %}
                <div class="book-info">
                    <strong>ISBN:</strong> {{ book.isbn }}
                </div>
                {% endif %}

                {% if book.rating %}
                <div class="book-rating">
                    <strong>Rating:</strong>
                    <div class="rating-stars">
                        {% with display_rating=book.display_rating %}
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= display_rating %}
                                    <img src="{% static 'projectcv/icons/star-filled.png' %}"
                                         alt="Filled Star"
                                        class="rating-star filled-star"
                                        onerror="this.style.display='none';">
                                {% else %}
                                    <img src="{% static 'projectcv/icons/star-empty.png' %}"
                                         alt="Empty Star"
                                        class="rating-star empty-star"
                                        onerror="this.style.display='none';">
                                {% endif %}
                            {% endfor %}
                            <span class="rating-text">
                                ({{ display_rating }}/5
                                {% if vote_count > 0 %}
                                    - {{ vote_count }} vote{{ vote_count|pluralize }}
                                {% endif %})
                            </span>
                        {% endwith %}
                    </div>
                </div>
                {% if user.is_authenticated %}
                <div class="rating-action mt-3">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#ratingModal">
                        {% if user_vote %}Update MY Rating{% else %}Rate This Book{% endif %}
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Social Media Links -->
            <div class="social-links">
                {% load static %}
                {% if book.facebook_url %}
                    <a href="{{ book.facebook_url }}" class="social-link facebook" title="Facebook" target="_blank" rel="noopener noreferrer">
                        <img src="{% static 'projectcv/icons/facebook.png' %}" alt="Facebook" class="social-icon-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                        <span class="social-text">Facebook</span>
                    </a>
                {% endif %}

                {% if book.instagram_url %}
                    <a href="{{ book.instagram_url }}" class="social-link instagram" title="Instagram" target="_blank" rel="noopener noreferrer">
                        <img src="{% static 'projectcv/icons/instagram.png' %}" alt="Instagram" class="social-icon-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                        <span class="social-text">Instagram</span>
                    </a>
                {% endif %}

                {% if book.amazon_url %}
                    <a href="{{ book.amazon_url }}" class="social-link amazon" title="Amazon" target="_blank" rel="noopener noreferrer">
                        <img src="{% static 'projectcv/icons/amazon.png' %}" alt="Amazon" class="social-icon-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                        <span class="social-text">Amazon</span>
                    </a>
                {% endif %}
            </div>






            <!-- Authro Bio Section - Left Bottom Corner -->
            <div class="author-bio-container">
                <div class="author-bio-frame">
                    <h4>About the Author</h4>
                    {% if book.author_photo %}
                        <img src="{{ book.author_photo.url }}" alt="{{ book.author }}" class="author-photo">
                    {% else %}
                        <div class="author-photo-placeholder">
                            <i class="fas fa-user"></i>
                        </div>
                    {% endif %}
                    <div class="author-bio-text">
                        {% if book.author_bio %}
                            {{ book.author_bio|linebreaks }}
                        {% else %}
                            <p class="text-muted">No author biography available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>





    <!-- Comments Section - Right Column -->
    <div class="comments-section">
        <h4>Reader Comments</h4>

        <!-- Comments List Scroll -->
        <div class="comments-list">
            {% for comment in book.comments.all %}
                <div class="comment-item">
                    <div class="comment-header">
                        <strong>{{ comment.user.email| default:"Anonymous" }}</strong>
                        <span class="comment-date">{{ comment.created_at| date:"M d, Y" }}</span>
                    </div>
                    <div class="comment-text">{{ comment.content }}</div>
                </div>
            {% empty %}
                <p class="no-comments">No comments yet. Be the first to comment!</p>
            {% endfor %}
        </div>

            <!-- Comment Form -->
            <div class="comment-form-container">
                <form method="post" class="comment-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <textarea name="comment" placeholder="Write your comment here..." rows="3" class="form-control comment-input"></textarea>
                    </div>
                    <div class="form-actions">
                        <div class="emoji-picker">
                            <span class="emoji" data-emoji="üòä">üòä</span>
                            <span class="emoji" data-emoji="üòç">üòç</span>
                            <span class="emoji" data-emoji="üòÇ">üòÇ</span>
                            <span class="emoji" data-emoji="üòÖ">üòÖ</span>
                            <span class="emoji" data-emoji="ü§©">ü§©</span>
                            <span class="emoji" data-emoji="üôè">üôè</span>
                            <span class="emoji" data-emoji="üòî">üòî</span>
                            <span class="emoji" data-emoji="üò†">üò†</span>
                        </div>
                        <button type="submit" class="btn btn-primary">Send Comment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Detect if  FontAwesome loaded successfully
document.addEventListener('DOMContentLoaded', function() {
    // Test if FontAwesome is loaded by checking if the icon has content
    const testIcon = document.createElement('i');
    testIcon.className = 'fas fa-facebook-f';
    testIcon.style.position = 'absolute';
    testIcon.style.visibility = 'hidden';
    document.body.appendChild(testIcon);

    // Check if the icon has proper styling after a brief delay
    setTimeout(function() {
        const computedStyle = window.getComputedStyle(testIcon, ':before');
        const hasContent = computedStyle.content && computedStyle.content !=='none' && computedStyle.content !== '""';

        if (!hasContent) {
            // FontAwesome failed to load, add fallback class
            document.body.classList.add('no-font-awesome');
        }

        // Clean up test element
        document.body.removeChild(testIcon);
    }, 100);
});

//Modal star rating interaction
document.addEventListener('DOMContentLoaded', function() {
    const starLabels = document.querySelectorAll('.star-label-modal');
    const ratingTextModal = document.querySelector('.rating-text-modal small');

    starLabels.forEach((label, index) => {
        const input = label.querySelector('.star-input-modal');

        label.addEventListener('mouseenter', function() {
            // Hightlight stars up to hovered star
            starLabels.forEach((l, i) => {
                const star = l.querySelector('.star-display-modal');
                if (i <= index) {
                    star.style.color = '#ffc107';
                } else {
                    star.style.color = '#ddd';
                }
            });

            // Update text
            const rating = index + 1;
            ratingTextModal.textContent = `${rating} star${rating !== 1 ? 's' : ''}`;
        });

        label.addEventListener('mouseleave', function() {
            // Reset to checked state
            const checkedInput = document.querySelector('.star-input-modal:checked');
            if (checkedInput) {
                const checkedIndex = Array.from(starLabels).findIndex(l =>
                    l.querySelector('.star-input-modal') === checkedInput
                );
                starLabels.forEach((l, i) => {
                    const star = l.querySelector('.star-display-modal');
                    star.style.color = i <= checkedIndex ? '#ffc107' : '#ddd';
                });
                ratingTextModal.textContent = `${checkedIndex + 1} star${checkedIndex !== 0 ? 's' : ''} selected`;
            } else {
                starLabels.forEach(l => {
                    l.querySelector('.star-display-modal').style.color = '#ddd';
                });
                ratingTextModal.textContent = 'Click on a star to rate';
            }
        });

        input.addEventListener('change', function() {
            if (this.checked) {
                ratingTextModal.textContent = `${index + 1} star${index !== 0 ? 's' : ''} selected`;
            }
        });
    });

    // Reset modal when closed
    document.getElementById('ratingModal').addEventListener('hidden.bs.modal', function() {
        starLabels.forEach(l => {
            const star = l.querySelector('.star-display-modal');
            const input = l.querySelector('.star-input-modal');
            star.style.color = input.checked ? '#ffc107' : '#ddd';
        });
    });
});

// Emoji Picker functionality
document.querySelectorAll('.emoji').forEach(emoji => {
    emoji.addEventListener('click', function() {
        const textarea= document.querySelector('.comment-input');
        const emojiValue = this.getAttribute('data-emoji');
        textarea.value += emojiValue;
        textarea.focus();
    });
});
function submitRating() {
    const form = document.getElementById('modalRatingForm');
    const selectedRating = form.querySelector('input[name="vote_rating"]:checked');

    if (!selectedRating) {
        alert('Please select a rating before submitting.');
        return;
    }

    form.submit();
}
</script>

<!-- Rating Modal -->
{% if user.is_authenticated %}
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ratingModalLabel">
                    {% if user_vote %}Update Your Rating{% else %}Rate This Book{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h6>{{ book.title }}</h6>
                    <p class="text-muted">by {{ book.author }}</p>
                </div>

                <form method="post" class="vote-form" id="modalRatingForm">
                    {% csrf_token %}
                    <div class="rating-input text-center">
                        <label class="form-label">Select your rating:</label>
                        <div class="star-rating-modal mt-2">
                            {% for i in "12345"|make_list %}
                                <label class="star-label-modal">
                                    <input type="radio" name="vote_rating" value="{{ forloop.counter }}"
                                           {% if user_vote.rating == forloop.counter %}checked{% endif %}
                                           class="star-input-modal">
                                    <span class="star-display-modal">‚òÖ</span>
                                </label>
                            {% endfor %}
                        </div>
                        <div class="rating-text-modal mt-2">
                            <small class="text-muted">Click on a star to rate</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitRating()">
                    {% if user_vote %}Update Rating{% else %}Submit Rating{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}